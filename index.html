<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mitt Familjeträd</title>
<style>
/* Kortad för enkelhet */
.hidden{display:none!important}
.disabled{opacity:.6;pointer-events:none}
</style>
<script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.umd.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>
<body>
<div id="loginView">
  <input id="username" placeholder="användare" />
  <input id="password" type="password" placeholder="lösen" />
  <button id="loginBtn">Logga in</button>
</div>
<div id="appView" class="hidden">
  <h3>Lägg till person</h3>
  <input id="personName" placeholder="Namn" />
  <select id="personGender" required>
    <option value="">Välj kön</option>
    <option value="male">Man</option>
    <option value="female">Kvinna</option>
    <option value="other">Annan</option>
  </select>
  <input id="personImage" type="file" accept="image/*" />
  <button id="addPersonBtn">Spara person</button>
  
  <div id="relationContainer" class="disabled">
    <h3>Lägg till relation</h3>
    <!-- Ordning: Person A, Relation, Person B -->
    <select id="relA"></select>
    <select id="relType">
      <option value="father">far till</option>
      <option value="mother">mor till</option>
      <option value="son">son till</option>
      <option value="daughter">dotter till</option>
    </select>
    <select id="relB"></select>
    <button id="addRelBtn" disabled>Spara relation</button>
  </div>
  
  <div id="cy" style="height:60vh;"></div>
</div> style="height:60vh;"></div>
</div>
<script>
const DEFAULT_USER='admin',DEFAULT_PASS='admin';
const LS_KEY_LOGIN='ft_login_ok_v1',LS_KEY_DATA='ft_data_v1';
const $=s=>document.querySelector(s);
let data,cy;

function loadData(){try{return JSON.parse(localStorage.getItem(LS_KEY_DATA))||{people:{},relations:[]}}catch{return{people:{},relations:[]}}}
function saveData(){localStorage.setItem(LS_KEY_DATA,JSON.stringify(data))}

$('#loginBtn').onclick=()=>{
 if($('#username').value===DEFAULT_USER&&$('#password').value===DEFAULT_PASS){
  localStorage.setItem(LS_KEY_LOGIN,'1');
  $('#loginView').classList.add('hidden');
  $('#appView').classList.remove('hidden');
  initApp();
 } else alert('Fel inloggning');
}

function initApp(){
 data=loadData();
 mountSelects();
 buildGraph();
 updateRelationUIState();
}

$('#addPersonBtn').onclick=async()=>{
 const name=$('#personName').value.trim();
 const gender=$('#personGender').value;
 if(!name) return alert('Ange namn');
 if(!gender) return alert('Välj kön');
 let photoDataUrl='';
 if($('#personImage').files[0]) photoDataUrl=await fileToDataURL($('#personImage').files[0]);
 const id='p_'+Math.random().toString(36).slice(2,10);
 data.people[id]={id,name,gender,photoDataUrl};
 saveData();
 $('#personName').value='';$('#personGender').value='';$('#personImage').value='';
 mountSelects();
 addNodeToGraph(data.people[id]);
 updateRelationUIState();
 if(cy) cy.fit(undefined,50);
};
 saveData();
 $('#personName').value='';$('#personGender').value='';$('#personImage').value='';
 mountSelects();
 addNodeToGraph(data.people[id]);
 updateRelationUIState();
}

function updateRelationUIState(){
 const c=Object.keys(data.people).length;
 const btn=document.getElementById('addRelBtn');
 const a=document.getElementById('relA').value;
 const b=document.getElementById('relB').value;
 const both=a && b && a!==b;
 if(c<2){
   document.getElementById('relationContainer').classList.add('disabled');
   btn.disabled=true;
 } else {
   document.getElementById('relationContainer').classList.remove('disabled');
   btn.disabled=!both;
 }
}

function mountSelects(){
 const opts=Object.values(data.people).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
 document.getElementById('relA').innerHTML='<option value="">–välj–</option>'+opts;
 document.getElementById('relB').innerHTML='<option value="">–välj–</option>'+opts;
 updateRelationUIState();
}">${p.name}</option>`).join('');
 $('#relA').innerHTML='<option value="">–välj–</option>'+opts;
 $('#relB').innerHTML='<option value="">–välj–</option>'+opts;
}

$('#addRelBtn').onclick=()=>{
 const type=$('#relType').value;
 const a=$('#relA').value;
 const b=$('#relB').value;
 if(!a||!b||a===b) return alert('Välj två olika personer');
 let parentId,childId;
 if(type==='father'||type==='mother'){ parentId=a; childId=b; }
 else { parentId=b; childId=a; }
 // sätt kön baserat på relationen när möjligt
 if(type==='father') data.people[parentId].gender='male';
 if(type==='mother') data.people[parentId].gender='female';
 if(type==='son') data.people[childId].gender='male';
 if(type==='daughter') data.people[childId].gender='female';
 if(!data.relations.some(r=>r.from===parentId&&r.to===childId)){
   data.relations.push({from:parentId,to:childId,type:(type==='father'||type==='mother')?type:'parent'});
   saveData();
   addEdgeToGraph({from:parentId,to:childId,type:(type==='father'||type==='mother')?type:'parent'});
   // uppdatera könsklass i grafen
   const pe=cy.getElementById(parentId); const ce=cy.getElementById(childId);
   if(pe){ pe.removeClass('male female other unknown'); pe.addClass(data.people[parentId].gender||'unknown'); }
   if(ce){ ce.removeClass('male female other unknown'); ce.addClass(data.people[childId].gender||'unknown'); }
   layoutGraph();
   cy.fit(undefined,50);
   $('#relA').value=''; $('#relB').value=''; updateRelationUIState();
   alert('Relation sparad');
 } else {
   alert('Relationen finns redan');
 }
}else{parentId=b;childId=a;}
 if(!data.relations.some(r=>r.from===parentId&&r.to===childId)){
  data.relations.push({from:parentId,to:childId,type});
  saveData();
  addEdgeToGraph({from:parentId,to:childId,type});
  layoutGraph();
 }
}

function fileToDataURL(file){return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file)})}

function buildGraph(){
 const elements=[];
 Object.values(data.people).forEach(p=>elements.push({data:{id:p.id,label:p.name,photo:p.photoDataUrl||''},classes:(p.gender||'unknown')}));
 data.relations.forEach(r=>elements.push({data:{id:r.from+'=>'+r.to,source:r.from,target:r.to,type:r.type}}));
 if(cy) cy.destroy();
 cy=cytoscape({
  container:$('#cy'),
  elements,
  style:[
    {selector:'node',style:{'label':'data(label)','font-size':12,'background-image':'data(photo)','background-fit':'cover cover','background-color':'#11203a','border-width':2,'border-color':'#5cc8ff','shape':'round-rectangle','padding':'10px'}},
    {selector:'node.male',style:{'border-color':'#6be675','background-color':'#0e1a34'}},
    {selector:'node.female',style:{'border-color':'#f59ecb','background-color':'#28122a'}},
    {selector:'node.other',style:{'border-color':'#ffcc66','background-color':'#2a1f0e'}},
    {selector:'node.unknown',style:{'border-color':'#5cc8ff','background-color':'#11203a'}},
    {selector:'edge',style:{'width':2,'line-color':'#6b7da6','target-arrow-color':'#6b7da6','target-arrow-shape':'triangle','curve-style':'bezier','control-point-step-size':40}},
    {selector:'edge[type="father"]',style:{'line-style':'solid'}},
    {selector:'edge[type="mother"]',style:{'line-style':'dashed'}},
  ],
  layout:{name:'dagre'}
});
},classes:p.gender}));
 data.relations.forEach(r=>elements.push({data:{id:r.from+'=>'+r.to,source:r.from,target:r.to,type:r.type}}));
 if(cy) cy.destroy();
 cy=cytoscape({
  container:$('#cy'),
  elements,
  style:[
    {selector:'node',style:{'label':'data(label)','font-size':12,'background-image':'data(photo)','background-fit':'cover cover','background-color':'#11203a','border-width':2,'border-color':'#5cc8ff','shape':'round-rectangle','padding':'10px'}},
    {selector:'node.male',style:{'border-color':'#6be675','background-color':'#0e1a34'}},
    {selector:'node.female',style:{'border-color':'#f59ecb','background-color':'#28122a'}},
    {selector:'node.other',style:{'border-color':'#ffcc66','background-color':'#2a1f0e'}},
    {selector:'node.unknown',style:{'border-color':'#5cc8ff','background-color':'#11203a'}},
    {selector:'edge',style:{'width':2,'line-color':'#6b7da6','target-arrow-color':'#6b7da6','target-arrow-shape':'triangle','curve-style':'bezier','control-point-step-size':40}},
    {selector:'edge[type="father"]',style:{'line-style':'solid'}},
    {selector:'edge[type="mother"]',style:{'line-style':'dashed'}},
  ],
  layout:{name:'dagre'}
});
}

function addNodeToGraph(p){cy.add({data:{id:p.id,label:p.name,photo:p.photoDataUrl||''},classes:p.gender});layoutGraph();}
function addEdgeToGraph(r){cy.add({data:{id:r.from+'=>'+r.to,source:r.from,target:r.to,type:r.type}});}
function layoutGraph(){cy.layout({name:'dagre'}).run();}
</script>
</body>
</html>
