<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mitt Familjeträd</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#0b1020;color:#fff}
    .hidden{display:none}
    .panel{padding:1rem}
    label{display:block;margin-top:.5rem}
    input,select,button{margin-top:.25rem;padding:.4rem}
    #cy{width:100%;height:60vh;background:#111;margin-top:1rem}
  </style>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.umd.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>
<body>
  <div class="panel" id="loginView">
    <h2>Logga in</h2>
    <label>Användarnamn <input id="username" type="text"></label>
    <label>Lösenord <input id="password" type="password"></label>
    <button id="loginBtn">Logga in</button>
  </div>

  <div class="panel hidden" id="appView">
    <h2>Lägg till person</h2>
    <label>Namn <input id="personName" type="text"></label>
    <label>Kön <select id="personGender"><option value="unknown">Okänt</option><option value="male">Man</option><option value="female">Kvinna</option></select></label>
    <label>Bild <input id="personImage" type="file" accept="image/*"></label>
    <button id="addPersonBtn">Spara person</button>

    <div id="relationSection" class="hidden">
      <h3>Lägg till relation</h3>
      <select id="relType"><option value="father">far till</option><option value="mother">mor till</option><option value="son">son till</option><option value="daughter">dotter till</option></select>
      <select id="relA"></select>
      <select id="relB"></select>
      <button id="addRelBtn">Lägg till relation</button>
    </div>

    <div id="cy"></div>
  </div>

<script>
const DEFAULT_USER='admin',DEFAULT_PASS='admin';
const LS_KEY_LOGIN='ft_login_ok_v1',LS_KEY_DATA='ft_data_v1';
const $=s=>document.querySelector(s);
let data=null,cy=null;

function loadData(){try{return JSON.parse(localStorage.getItem(LS_KEY_DATA))||{people:{},relations:[]}}catch{return{people:{},relations:[]}}}
function saveData(d){localStorage.setItem(LS_KEY_DATA,JSON.stringify(d))}
function uid(){return'p_'+Math.random().toString(36).slice(2,10)}

$('#loginBtn').onclick=()=>{
  if($('#username').value===DEFAULT_USER&&$('#password').value===DEFAULT_PASS){
    localStorage.setItem(LS_KEY_LOGIN,'1');
    $('#loginView').classList.add('hidden');
    $('#appView').classList.remove('hidden');
    initApp();
  }else alert('Fel inloggning');
}

function initApp(){
  data=loadData();
  mountSelects();
  buildGraph();
  toggleRelationSection();
}

function toggleRelationSection(){
  if(Object.keys(data.people).length>=2){
    $('#relationSection').classList.remove('hidden');
  }else{
    $('#relationSection').classList.add('hidden');
  }
}

$('#addPersonBtn').onclick=async()=>{
  const name=$('#personName').value.trim();
  if(!name)return alert('Ange namn');
  const gender=$('#personGender').value;
  let photoDataUrl='';
  const file=$('#personImage').files?.[0];
  if(file)photoDataUrl=await fileToDataURL(file);
  const id=uid();
  data.people[id]={id,name,gender,photoDataUrl};
  saveData(data);
  $('#personName').value='';$('#personImage').value='';
  mountSelects();
  addNodeToGraph(data.people[id]);
  toggleRelationSection();
}

function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(file)})}

function mountSelects(){
  const opts=Object.values(data.people).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  $('#relA').innerHTML='<option value="">– välj –</option>'+opts;
  $('#relB').innerHTML='<option value="">– välj –</option>'+opts;
}

$('#addRelBtn').onclick=()=>{
  const type=$('#relType').value,a=$('#relA').value,b=$('#relB').value;
  if(!a||!b||a===b)return alert('Välj två olika personer');
  let parentId,childId;
  if(type==='father'||type==='mother'){parentId=a;childId=b;}
  else{parentId=b;childId=a;}
  if(!data.relations.some(r=>r.from===parentId&&r.to===childId)){
    data.relations.push({from:parentId,to:childId,type:type});
    saveData(data);
    addEdgeToGraph({from:parentId,to:childId,type:type});
    layoutGraph();
  }
}

function buildGraph(){
  const elements=[];
  Object.values(data.people).forEach(p=>{
    elements.push({data:{id:p.id,label:p.name,photo:p.photoDataUrl||''}});
  });
  data.relations.forEach(r=>{
    elements.push({data:{id:r.from+'=>'+r.to,source:r.from,target:r.to}});
  });
  if(cy)cy.destroy();
  cy=cytoscape({container:$('#cy'),elements,style:[{selector:'node',style:{'label':'data(label)','background-image':'data(photo)','background-fit':'cover cover','border-width':2,'border-color':'#5cc8ff','background-color':'#11203a'}},{selector:'edge',style:{'line-color':'#6b7da6','target-arrow-color':'#6b7da6','target-arrow-shape':'triangle'}}],layout:{name:'dagre'}});
}

function addNodeToGraph(p){cy.add({data:{id:p.id,label:p.name,photo:p.photoDataUrl||''}});layoutGraph();}
function addEdgeToGraph(r){cy.add({data:{id:r.from+'=>'+r.to,source:r.from,target:r.to}});}
function layoutGraph(){cy.layout({name:'dagre'}).run();}
</script>
</body>
</html>
